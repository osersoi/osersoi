import * as sass from 'sass';
import path from 'path';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));

export default function(eleventyConfig) {

    // ==========================================
    //  SCSS → CSS (output dans /css/)
    // ==========================================
    eleventyConfig.addTemplateFormats("scss");
    eleventyConfig.addExtension("scss", {
        outputFileExtension: "css",

        compile: async function(inputContent, inputPath) {
            let parsed = path.parse(inputPath);
            if (parsed.name.startsWith("_")) return undefined;

            let result = sass.compile(inputPath, {
                loadPaths: [
                    path.join(__dirname, "src", "css")
                ],
                style: "compressed"
            });

            this.addDependencies(inputPath, result.loadedUrls);
            return async () => result.css;
        }
    });

    eleventyConfig.addPassthroughCopy("src/images");
    eleventyConfig.addPassthroughCopy("src/CNAME");

    // Collection d'articles de blog, triés par date décroissante
    eleventyConfig.addCollection("blog", function(collectionApi) {
        return collectionApi.getFilteredByGlob("src/posts/*.md").sort((a, b) => {
            return b.date - a.date;
        });
    });

    // Filtre pour formater les dates en français
    eleventyConfig.addFilter("dateFormat", function(date) {
        return new Date(date).toLocaleDateString("fr-CH", {
            year: "numeric",
            month: "long",
            day: "numeric"
        });
    });
    
    // Filtre pour l'année courante
    eleventyConfig.addFilter("year", function() {
        return new Date().getFullYear();
    });

    return {
        dir: {
            input: "src",
            output: "_site",
            includes: "_includes",
            data: "_data"
        },
        markdownTemplateEngine: "njk",
        htmlTemplateEngine: "njk"
    };
}

